steps:
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', '$_TARGET_REGION-docker.pkg.dev/$_DEPLOY_PROJECT_ID/$_SERVICE_NAME/$_CONTAINER_NAME:$COMMIT_SHA', '.' ]
# Push with Commit SHA as Tag
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', '$_TARGET_REGION-docker.pkg.dev/$_DEPLOY_PROJECT_ID/$_SERVICE_NAME/$_CONTAINER_NAME:$COMMIT_SHA']
# Deploy container image to Cloud Run
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: bash
  args:
  - '-c'
  - 'gcloud run deploy $_SERVICE_NAME
    --image=$_TARGET_REGION-docker.pkg.dev/$_DEPLOY_PROJECT_ID/$_SERVICE_NAME/$_CONTAINER_NAME:$COMMIT_SHA
    --platform=$_PLATFORM
    --labels=managed-by=gcp-cloud-build-deploy-cloud-run,commit-sha=$COMMIT_SHA,gcb-build-id=$BUILD_ID,gcb-trigger-id=$_TRIGGER_ID,$_LABELS
    --region=$_TARGET_REGION
    --project=$_DEPLOY_PROJECT_ID
    --port=$_PORT
    --set-env-vars=SENDGRID_API_KEY=$$SENDGRID_API_KEY'
images:
  - '$_TARGET_REGION-docker.pkg.dev/$_DEPLOY_PROJECT_ID/$_SERVICE_NAME/$_CONTAINER_NAME:$COMMIT_SHA'
  - '$_TARGET_REGION-docker.pkg.dev/$_DEPLOY_PROJECT_ID/$_SERVICE_NAME/$_CONTAINER_NAME:latest'
tags:
    - gcp-cloud-build-deploy-cloud-run
    - gcp-cloud-build-deploy-cloud-run-managed